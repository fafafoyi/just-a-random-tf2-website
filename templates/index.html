<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>MANN CO. MEME REPOSITORY</title>
</head>
<body class="red-team">

    <nav class="tf-nav">
        <div class="nav-left">
            <a href="{{ url_for('index') }}">HOME</a>
            <a href="{{ url_for('profile') }}">PERSONNEL FILE</a>
            <button id="mute-btn" onclick="toggleMute()" class="mute-toggle">ðŸ”Š</button>
        </div>
        <div class="nav-right">
            <span class="user-tag">{{ current_user.username }}</span>
            
            <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" class="circle-pfp">
            <a href="{{ url_for('logout') }}" class="logout-btn">Log out</a>
        </div>
    </nav>


  <div class="class-selection">
    <h2>SELECT YOUR CLASS</h2>
    <div class="class-grid">
        {% for cls in classes %} <div class="class-card-container">
            <div class="class-card" onmouseenter="playClassSound('{{ cls }}')" onclick="togglePocket('{{ cls }}')">
                <img src="{{ url_for('static', filename='images/classes/' + cls + '.png') }}" alt="{{ cls }}">
                <p>{{ cls.upper() }}</p>
            </div>

            <div id="pocket-{{ cls }}" class="merc-pocket">
                <div class="pocket-content">
                    <span class="close-pocket" onclick="togglePocket('{{ cls }}')">âœ–</span>
                    <h3>ROLE: <span class="role-text">{{ roles[cls] }}</span></h3>

                
                    <video width="320" height="180" controls class="pocket-video">
                        <source src="{{ url_for('static', filename='videos/' + cls + '.mp4') }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div> {% endfor %} </div>
    </div>
    
    <audio id="class-audio" style="display:none;"></audio>
    <audio id="tv-on-sound" src="{{ url_for('static', filename='sounds/tv_on.mp3') }}" preload="auto"></audio>

    <script>
        var isMuted = localStorage.getItem('tf2_muted') === 'true';

        function updateButtonUI() {
            var btn = document.getElementById('mute-btn');
            if (btn) {
                btn.innerText = isMuted ? "ðŸ”ˆ" : "ðŸ”Š";
                if (isMuted) {
                    btn.classList.add('muted');
                } else {
                    btn.classList.remove('muted');
                }
            }
        }

        window.addEventListener('load', updateButtonUI);
     
        function toggleMute() {
            isMuted = !isMuted;

            localStorage.setItem('tf2_muted', isMuted);
            var btn = document.getElementById('mute-btn');
            var audio = document.getElementById('class-audio');
            
                
            if (isMuted) {
                btn.innerText = "ðŸ”ˆ";
                btn.classList.add('muted');
                if (audio) {
                    audio.pause(); // Stop immediately
                    audio.currentTime = 0; 
                }
            } else {
                btn.innerText = "ðŸ”Š";
                btn.classList.remove('muted');
            }
                
        }
    function playClassSound(className) {
    //If isMuted is true, the rest of the code is ignored
        if (isMuted === true) {
            return; 
        }

        var audio = document.getElementById('class-audio');
        if (audio) {
            audio.src = "{{ url_for('static', filename='sounds/classes/') }}" + className + ".mp3";
            audio.volume = 0.2;
            audio.play().catch(function(serror) {
                console.log("Playback blocked: " + error);
            });
        }
    }

    function togglePocket(className) {
    // Stop the character's hover voice
   
        var classAudio = document.getElementById('class-audio');
        if (classAudio) {
            classAudio.pause();
            classAudio.currentTime = 0;
        }

        var pocket = document.getElementById('pocket-' + className);
        var tvOnSound = document.getElementById('tv-on-sound');

        // Helper function to close a pocket with animation
        function closePocket(p) {
            if (p.classList.contains('active')) {
                p.classList.remove('active');
                p.classList.add('closing');
                var v = p.querySelector('video');
                if (v) v.pause();
                
                // Wait for animation to finish before hiding
                setTimeout(() => {
                    p.classList.remove('closing');
                    p.style.display = 'none';
                }, 300); 
            }
        }
        

        if (pocket.classList.contains('active')) {
            closePocket(pocket);
        } else {
            // Close all other TVs first
            document.querySelectorAll('.merc-pocket').forEach(p => {
                closePocket(p);
            });

            // Open the new TV
            if (tvOnSound && !isMuted) {
                tvOnSound.currentTime = 0;
                tvOnSound.play();
            }

            pocket.style.display = 'block';
            pocket.classList.add('active');

            setTimeout(() => {
                var vid = pocket.querySelector('video');
                if (vid) vid.play().catch(e => console.log("Autoplay blocked"));
            }, 400);
        }
        setTimeout(() => {
            if (video) {
                video.play();
                
                // EASTER EGG: Only if character is heavy
                if (className === 'heavy') {
                    video.onended = function() {
                        // 1. Shake and Flash
                        pocket.classList.add('animate-shake');
                        flash.classList.add('animate-explode');
                        
                        // 2. Optional: Play explosion sound
                        console.log("BOOM! Heavy's monitor exploded.");

                        // 3. Reset after explosion
                        setTimeout(() => {
                            pocket.classList.remove('active', 'animate-shake');
                            flash.classList.remove('animate-explode');
                            pocket.style.display = 'none';
                            video.currentTime = 0;
                        }, 700);
                    };
                }
            }
        }, 400);
    }

    

    // 2. Handle closing other pockets to keep the UI clean
    document.querySelectorAll('.merc-pocket').forEach(p => {
        if (p.id !== 'pocket-' + className) {
            p.style.display = 'none';
            // Also pause any videos playing in other pockets
            var otherVid = p.querySelector('video');
            if (otherVid) otherVid.pause();
        }
    });

    // 3. Toggle the current pocket
    var pocket = document.getElementById('pocket-' + className);
    if (pocket.style.display === "block") {
        pocket.style.display = "none";
        var currentVid = pocket.querySelector('video');
        if (currentVid) currentVid.pause(); // Stop video if pocket is closed
    } else {
        pocket.style.display = "block";
    }

    
    </script>

    <div class="terminal-box" style="margin-top: 50px;">
        <h3>TRANSMIT INTEL</h3>
        <form method="POST" enctype="multipart/form-data">
            <textarea name="content" placeholder="Enter message here..."></textarea>
            
            <input type="file" name="post_image" id="intel-upload" accept="image/*" hidden>
            
            <label for="intel-upload" class="custom-file-upload">
                ATTACH INTEL PHOTO
            </label>

            <button type="submit" class="tf-button-send">SEND BROADCAST</button>
        </form>
    </div>
    
    <div class="intel-feed">
    {% for post in posts %}
    <div class="post-card">
        <div class="post-header">
            <span class="username">{{ post.author.username }}</span>
            
            <span class="post-date">
                {{ post.date_posted.strftime('%b %d - %H:%M') }}
            </span>
        </div>
        
        <p class="post-content">{{ post.content }}</p>

        {% if post.image_file %}
            <div class="post-image-container">
                <img src="{{ url_for('static', filename='post_pics/' + post.image_file) }}" class="post-img">
            </div>
        {% endif %}
    </div>
    {% endfor %}
    </div>



    <div class="gallery">
        {% for meme in memes %}
            <div class="meme-card">
                <img src="{{ url_for('static', filename='images/' + meme) }}" alt="TF2 Meme">
                <div class="caption">Item: {{ meme }}</div>
            </div>
        {% endfor %}
    </div>
</body>
</html>